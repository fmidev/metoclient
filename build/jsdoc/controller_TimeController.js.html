<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controller/TimeController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controller/TimeController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Time controller for animator.
 * @author Finnish Meteorological Institute
 * @license MIT
 */

import Time from '../model/Time'
import TimeSlider from '../view/time/TimeSlider'
import * as constants from '../constants'
import EventEmitter from 'wolfy87-eventemitter'

export default class TimeController {
  /**
   * Constructs a new time controller.
   * @param {Object} config User
   * @constructor
   */
  constructor (config) {
    /**
     * @type {Object}
     * @private
     */
    this.config_ = config
    this.variableEvents = new EventEmitter()
    this.actionEvents = new EventEmitter()
    /**
     * @function
     * @param {number} animationTime Animation time.
     * @private
     */
    this.animationTimeTimerListener_ = animationTime => {
    }
    /**
     * @function
     * @private
     */
    this.playListener_ = () => {
    }
    /**
     * @function
     * @private
     */
    this.refreshListener_ = () => {
    }
    /**
     * @function
     * @private
     */
    this.previousListener_ = () => {
    }
    /**
     * @function
     * @private
     */
    this.nextListener_ = () => {
    }
    /**
     * @function
     * @param {number} animationTime Animation time.
     * @private
     */
    this.animationTimeUserListener_ = animationTime => {
    }
    /**
     * @function
     * @param {boolean} animationPlay Animation playback state.
     * @private
     */
    this.animationPlayListener_ = animationPlay => {
    }
    /**
     * @function
     * @param {number} beginTime Animation begin time.
     * @private
     */
    this.beginTimeListener_ = beginTime => {
    }
    /**
     * @function
     * @param {number} endTime Animation end time.
     * @private
     */
    this.endTimeListener_ = endTime => {
    }
    /**
     * @function
     * @param {number} timeStep Animation time step.
     * @private
     */
    this.timeStepListener_ = timeStep => {
    }
    /**
     * @private
     */
    this.model_ = new Time(config['model'])
    /**
     * @private
     */
    this.views_ = []
  }

  /**
   * Produces a time model and views.
   * @param {Object=} callbacks Callback functions for time events.
   */
  createTime (callbacks) {
    const self = this
    let containers
    let numViews
    let i
    this.previousListener_ = () => {
      self.previous()
    }
    this.nextListener_ = () => {
      self.next()
    }
    this.animationTimeUserListener_ = (animationTime) => {
      self.setAnimationTime(animationTime)
      self.updateAnimationBackupTime()
    }
    this.animationPlayListener_ = (animationPlay) => {
      if (animationPlay) {
        self.play()
      } else {
        self.pause()
      }
    }
    this.beginTimeListener_ = (beginTime) => {
      self.setBeginTime(beginTime)
      self.actionEvents.emitEvent('refresh')
    }
    this.endTimeListener_ = (endTime) => {
      self.setEndTime(endTime)
      self.actionEvents.emitEvent('refresh')
    }
    this.timeStepListener_ = (timeStep) => {
      self.setTimeStep(timeStep)
      self.actionEvents.emitEvent('refresh')
    }
    this.firstDataPointTimeListener_ = (dataPoint) => {
      self.setFirstDataPointTime(dataPoint)
      self.actionEvents.emitEvent('refresh')
    }
    this.lastDataPointTimeListener_ = (dataPoint) => {
      self.setLastDataPointTime(dataPoint)
      self.actionEvents.emitEvent('refresh')
    }

    containers = document.getElementsByClassName(this.config_['view']['timeSliderContainer'])
    numViews = containers.length
    if (this.config_['view']['showTimeSlider']) {
      for (i = 0; i &lt; numViews; i++) {
        this.views_.push(new TimeSlider(this.config_['view'], containers[i], callbacks))
        this.views_[i].actionEvents.addListener('previous', self.previousListener_)
        this.views_[i].actionEvents.addListener('next', self.nextListener_)
        this.views_[i].variableEvents.addListener('animationTime', self.animationTimeUserListener_)
        this.views_[i].variableEvents.addListener('animationPlay', self.animationPlayListener_)
        this.views_[i].variableEvents.addListener('beginTime', self.beginTimeListener_)
        this.views_[i].variableEvents.addListener('endTime', self.endTimeListener_)
        this.views_[i].variableEvents.addListener('timeStep', self.timeStepListener_)
        this.views_[i].variableEvents.addListener('firstDataPointTime', self.firstDataPointTimeListener_)
        this.views_[i].variableEvents.addListener('lastDataPointTime', self.lastDataPointTimeListener_)
      }
    }

    /**
     * @private
     */
    this.playListener_ = () => {
      self.actionEvents.emitEvent('play')
    }
    this.model_.actionEvents.addListener('play', this.playListener_)
    /**
     * @private
     */
    this.refreshListener_ = () => {
      self.actionEvents.emitEvent('refresh')
    }
    this.model_.actionEvents.addListener('refresh', this.refreshListener_)
    /**
     * @private
     */
    this.animationTimeTimerListener_ = animationTime => {
      self.updateTimeSlider()
      self.variableEvents.emitEvent('animationTime', [animationTime])
    }
    this.model_.variableEvents.addListener('animationTime', this.animationTimeTimerListener_)

    this.createTimer()
  }

  /**
   * Creates a time slider for each view.
   */
  createTimeSlider () {
    const numViews = this.views_.length
    let i
    if (!this.config_['view']['showTimeSlider']) {
      return
    }
    for (i = 0; i &lt; numViews; i++) {
      this.views_[i].createTimeSlider(this.model_.getAnimationTimes(), this.model_.getTimeConfiguration())
    }
  }

  /**
   * Updates time slider in each view.
   */
  updateTimeSlider () {
    const animationTime = this.model_.getAnimationTime()
    const numViews = this.views_.length
    let i
    if (!this.config_['view']['showTimeSlider']) {
      return
    }
    for (i = 0; i &lt; numViews; i++) {
      this.views_[i].setAnimationTime(animationTime)
    }
  }

  /**
   * Updates time steps.
   * @param {Array&lt;Object>} numIntervalItems Loader counter information for intervals.
   */
  updateTimeSteps (numIntervalItems) {
    let numIntervals
    let i
    let empty = true
    if (numIntervalItems.length === 0) {
      if (this.config_['model']['resolutionTime'] == null) {
        this.model_.setAnimationTimes([])
        this.updateTimeLoaderVisualizations([])
      }
      return
    }
    if (this.getAnimationBackupTime() == null) {
      this.updateAnimationBackupTime()
    }
    // Remove empty time steps from start and end if not every step is empty
    if (!this.model_.getTimeLimitsForced()) {
      numIntervals = numIntervalItems.length
      for (i = 0; i &lt; numIntervals; i++) {
        if ((numIntervalItems[i].toBeLoaded == null) || (numIntervalItems[i].toBeLoaded > 0)) {
          empty = false
          break
        }
      }
      if (!empty) {
        i = 0
        while (i &lt; numIntervalItems.length) {
          if ((numIntervalItems[i].toBeLoaded == null) || (numIntervalItems[i].toBeLoaded > 0)) {
            break
          }
          numIntervalItems.shift()
          i++
        }
        i = numIntervalItems.length - 1
        while (i >= 0) {
          if ((numIntervalItems[i].toBeLoaded == null) || (numIntervalItems[i].toBeLoaded > 0)) {
            break
          }
          numIntervalItems.pop()
          i--
        }
      }
      numIntervals = numIntervalItems.length
    }
    this.model_.setAnimationTimes(numIntervalItems.reduce((animationTimes, intervalItem) => {
      animationTimes.push(intervalItem['endTime'])
      return animationTimes
    }, []))
    this.updateTimeLoaderVisualizations(numIntervalItems)
    this.updateTimeSlider()
    if (this.model_.isWaitingAutoStart()) {
      for (i = 0; i &lt; numIntervals; i++) {
        if (![constants.LOADING_STATUS['ready'], constants.LOADING_STATUS['error']].includes(numIntervalItems[i]['status'])) {
          return
        }
      }
      this.play()
    }
  }

  /**
   * Gets the real-world creation time.
   * @returns {number} Real-world creation time.
   */
  getCreationTime () {
    return this.model_.getCreationTime()
  }

  /**
   * Gets current real-world time.
   * @returns {number} Current real-world time.
   */
  getCurrentTime () {
    return this.model_.getCurrentTime()
  }

  /**
   * Gets animation time.
   * @returns {number} Animation time.
   */
  getAnimationTime () {
    return this.model_.getAnimationTime()
  }

  /**
   * Gets animation begin time.
   * @returns {number} Animation begin time.
   */
  getAnimationBeginTime () {
    return this.model_.getAnimationBeginTime()
  }

  /**
   * Gets animation end time.
   * @returns {number} Gets animation end time.
   */
  getAnimationEndTime () {
    return this.model_.getAnimationEndTime()
  }

  /**
   * Gets animation resolution time.
   * @returns {number} Animation resolution time.
   */
  getAnimationResolutionTime () {
    return this.model_.getAnimationResolutionTime()
  }
  /**
   * Gets number of animation time intervals.
   * @returns {number} Number of animation time intervals.
   */
  getAnimationNumIntervals () {
    return this.model_.getAnimationNumIntervals()
  }

  /**
   * Refreshes current real-world time.
   * @param {Object=} callbacks Callback functions for time events.   */
  refreshTime (callbacks) {
    // Configuration for static view or manual refresh
    if (this.model_.isValidRefreshInterval()) {
      let timeShift
      const currentTime = Date.now()
      let resolutionTime = this.model_.getAnimationResolutionTime()
      const creationTime = this.model_.getCreationTime()
      let animationTimes
      this.model_.setDefaultTime(this.model_.getAnimationTime())
      if (resolutionTime == null) {
        animationTimes = this.model_.getAnimationTimes()
        if ((animationTimes != null) &amp;&amp; (animationTimes.length > 0)) {
          resolutionTime = animationTimes[1] - animationTimes[0]
        }
      }
      timeShift = (resolutionTime != null) ? Math.floor(currentTime / resolutionTime) * resolutionTime - Math.floor(creationTime / resolutionTime) * resolutionTime : currentTime - creationTime
      this.model_.setAnimationLastRefreshed(currentTime)
      this.model_.setCurrentTime(currentTime)
      this.model_.moveAnimationTimeFrame(timeShift)
    }
    this.createTimeSlider()
    if (callbacks != null) {
      this.views_.forEach(view => {
        view.setCallbacks(callbacks)
      })
    }
  }

  /**
   * Starts to play animation.
   */
  play () {
    this.model_.play()
    this.views_.forEach(view => {
      view.setAnimationPlay(true)
    })
  }

  /**
   * Pauses animation.
   */
  pause () {
    this.model_.pause()
    this.views_.forEach(view => {
      view.setAnimationPlay(false)
    })
  }

  /**
   * Stops (pauses and rewinds) animation.
   */
  stop () {
    this.model_.stop()
    this.views_.forEach(view => {
      view.setAnimationPlay(false)
    })
  }

  /**
   * Moves to previous time frame.
   */
  previous () {
    this.model_.previous()
  }

  /**
   * Moves to next time frame.
   */
  next () {
    this.model_.next()
  }

  /**
   * Moves to given time frame.
   * @param time {number} Timestamp of new animation time.
   */
  setAnimationTime (time) {
    this.model_.setAnimationTime(time)
    this.updateAnimationBackupTime()
  }

  /**
   * Sets animations frame rate.
   * @param {number} frameRate Frame rate.
   */
  setFrameRate (frameRate) {
    this.model_.setFrameRate(frameRate)
  }

  /**
   * Sets animation grid time.
   * @param {number} gridTime Animation grid time.
   */
  setGridTime (gridTime) {
    this.model_.setGridTime(gridTime)
  }

  /**
   * Sets animation begin time.
   * @param {number} beginTime Animation begin time.
   */
  setBeginTime (beginTime) {
    this.model_.setBeginTime(beginTime)
  }

  /**
   * Sets animation end time.
   * @param {number} endTime Animation end time.
   */
  setEndTime (endTime) {
    this.model_.setEndTime(endTime)
  }

  /**
   * Sets the time of first available datapoint
   * @param {number} firstDataPointTime first available datapoint time
   */
  setFirstDataPointTime (firstDataPointTime) {
    this.model_.setFirstDataPointTime(firstDataPointTime)
  }

  /**
   * Sets the time of last available datapoint
   * @param {number} lastDataPointTime last available datapoint time
   */
  setLastDataPointTime (lastDataPointTime) {
    this.model_.setLastDataPointTime(lastDataPointTime)
  }

  /**
   * Sets time limits forced.
   * @param {boolean} timeLimitsForced Time limits forced.
   */
  setTimeLimitsForced (timeLimitsForced) {
    this.model_.setTimeLimitsForced(timeLimitsForced)
  }

  /**
   * Sets animation time step.
   * @param timeStep Animation time step.
   */
  setTimeStep (timeStep) {
    this.model_.setResolutionTime(timeStep)
  }

  /**
   * Sets time zone.
   * @param {string} timeZone Time zone.
   */
  setTimeZone (timeZone) {
    this.views_.forEach(view => {
      view.setTimeZone(timeZone)
    })
  }

  /**
   * Sets time zone.
   * @param {string} timeZoneLabel Time zone.
   */
  setTimeZoneLabel (timeZoneLabel) {
    this.views_.forEach(view => {
      view.setTimeZoneLabel(timeZoneLabel)
    })
  }

  /**
   * Sets time grid offset from midnight.
   * @param gridTimeOffset {Number} Time grid offset.
   */
  setDayStartOffset (gridTimeOffset) {
    this.model_.setDayStartOffset(gridTimeOffset)
  }

  /**
   * Produces a new timer definition.
   */
  createTimer () {
    this.model_.createTimer()
  }

  /**
   * Destroys current time model and views.
   */
  destroyTime () {
    const numViews = this.views_.length
    let i
    this.actionEvents.removeAllListeners()
    this.variableEvents.removeAllListeners()
    for (i = 0; i &lt; numViews; i++) {
      this.views_[i].destroyTimeSlider()
    }
    this.model_.destroyTimer()
  }

  /**
   * Gets animation time moments.
   * @return {Array&lt;number>} Time moments.
   */
  getAnimationTimes () {
    return this.model_.getAnimationTimes()
  }

  /**
   * Gets animation backup time.
   * @returns {number} Animation backup time.
   */
  getAnimationBackupTime () {
    return this.model_.getAnimationBackupTime()
  }

  /**
   * Updates animation backup time.
   */
  updateAnimationBackupTime () {
    this.model_.updateAnimationBackupTime()
  }

  /**
   * Updates animation backup time.
   */
  resetAnimationBackupTime () {
    this.model_.resetAnimationBackupTime()
  }

  /**
   * Sets callback functions.
   * @param callbacks {Object} Callback functions.
   */
  setCallbacks (callbacks) {
    this.views_.forEach(view => {
      view.setCallbacks(callbacks)
    })
  }

  /**
   *  Updates time loader visualizations.
   * @param numIntervalItems {Array} Numbers of interval items.
   */
  updateTimeLoaderVisualizations (numIntervalItems) {
    let i
    const numViews = this.views_.length
    for (i = 0; i &lt; numViews; i++) {
      this.views_[i].updateTimeLoaderVis(numIntervalItems)
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Base.html">Base</a></li><li><a href="Html.html">Html</a></li><li><a href="Internal.html">Internal</a></li><li><a href="MetOClient_MetOClient.html">MetOClient</a></li><li><a href="module.exports.html">exports</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="TimeFrame.module.exports.html">module.exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addFeatures">addFeatures</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#clearFeatures">clearFeatures</a></li><li><a href="global.html#configureTicks">configureTicks</a></li><li><a href="global.html#createContainers">createContainers</a></li><li><a href="global.html#createFrame">createFrame</a></li><li><a href="global.html#createFrames">createFrames</a></li><li><a href="global.html#createIndicators">createIndicators</a></li><li><a href="global.html#createMap">createMap</a></li><li><a href="global.html#createMenu">createMenu</a></li><li><a href="global.html#createPointer">createPointer</a></li><li><a href="global.html#createPostTools">createPostTools</a></li><li><a href="global.html#createPreMargin">createPreMargin</a></li><li><a href="global.html#createPreTools">createPreTools</a></li><li><a href="global.html#createTicks">createTicks</a></li><li><a href="global.html#createTime">createTime</a></li><li><a href="global.html#createTimeMenu">createTimeMenu</a></li><li><a href="global.html#createTimer">createTimer</a></li><li><a href="global.html#createTimeSlider">createTimeSlider</a></li><li><a href="global.html#createTimeZoneLabel">createTimeZoneLabel</a></li><li><a href="global.html#destroyAnimation">destroyAnimation</a></li><li><a href="global.html#destroyTime">destroyTime</a></li><li><a href="global.html#destroyTimer">destroyTimer</a></li><li><a href="global.html#destroyTimeSlider">destroyTimeSlider</a></li><li><a href="global.html#featureFactory">featureFactory</a></li><li><a href="global.html#filters">filters</a></li><li><a href="global.html#floorTime">floorTime</a></li><li><a href="global.html#getAnimationBackupTime">getAnimationBackupTime</a></li><li><a href="global.html#getAnimationBeginTime">getAnimationBeginTime</a></li><li><a href="global.html#getAnimationEndTime">getAnimationEndTime</a></li><li><a href="global.html#getAnimationNumIntervals">getAnimationNumIntervals</a></li><li><a href="global.html#getAnimationResolutionTime">getAnimationResolutionTime</a></li><li><a href="global.html#getAnimationTime">getAnimationTime</a></li><li><a href="global.html#getAnimationTimes">getAnimationTimes</a></li><li><a href="global.html#getCapabilities">getCapabilities</a></li><li><a href="global.html#getCreationTime">getCreationTime</a></li><li><a href="global.html#getCurrentTime">getCurrentTime</a></li><li><a href="global.html#getFeatures">getFeatures</a></li><li><a href="global.html#getFeaturesAt">getFeaturesAt</a></li><li><a href="global.html#getLayer">getLayer</a></li><li><a href="global.html#getLayerConfigs">getLayerConfigs</a></li><li><a href="global.html#getLayers">getLayers</a></li><li><a href="global.html#getMap">getMap</a></li><li><a href="global.html#getRefreshInterval">getRefreshInterval</a></li><li><a href="global.html#getStaticControls">getStaticControls</a></li><li><a href="global.html#getTickText">getTickText</a></li><li><a href="global.html#getTimeConfiguration">getTimeConfiguration</a></li><li><a href="global.html#getTimeLimitsForced">getTimeLimitsForced</a></li><li><a href="global.html#handleRefresh_">handleRefresh_</a></li><li><a href="global.html#handleTimer_">handleTimer_</a></li><li><a href="global.html#hidePopup">hidePopup</a></li><li><a href="global.html#isValidRefreshInterval">isValidRefreshInterval</a></li><li><a href="global.html#isWaitingAutoStart">isWaitingAutoStart</a></li><li><a href="global.html#layerFactory">layerFactory</a></li><li><a href="global.html#LEGEND_CONTAINER_CLASS">LEGEND_CONTAINER_CLASS</a></li><li><a href="global.html#LEGEND_FIGURE_CLASS_PREFIX">LEGEND_FIGURE_CLASS_PREFIX</a></li><li><a href="global.html#loadCapabilities">loadCapabilities</a></li><li><a href="global.html#loadFunction">loadFunction</a></li><li><a href="global.html#LOADING_STATUS">LOADING_STATUS</a></li><li><a href="global.html#MAX_TIMESTAMP">MAX_TIMESTAMP</a></li><li><a href="global.html#moveAnimationTimeFrame">moveAnimationTimeFrame</a></li><li><a href="global.html#next">next</a></li><li><a href="global.html#pause">pause</a></li><li><a href="global.html#play">play</a></li><li><a href="global.html#previous">previous</a></li><li><a href="global.html#produceFullLayerConfig">produceFullLayerConfig</a></li><li><a href="global.html#refreshLayers">refreshLayers</a></li><li><a href="global.html#refreshMap">refreshMap</a></li><li><a href="global.html#refreshTime">refreshTime</a></li><li><a href="global.html#requestViewUpdate">requestViewUpdate</a></li><li><a href="global.html#resetAnimationBackupTime">resetAnimationBackupTime</a></li><li><a href="global.html#selectFeature">selectFeature</a></li><li><a href="global.html#setAnimationLastRefreshed">setAnimationLastRefreshed</a></li><li><a href="global.html#setAnimationPlay">setAnimationPlay</a></li><li><a href="global.html#setAnimationTime">setAnimationTime</a></li><li><a href="global.html#setAnimationTimes">setAnimationTimes</a></li><li><a href="global.html#setBeginTime">setBeginTime</a></li><li><a href="global.html#setCallbacks">setCallbacks</a></li><li><a href="global.html#setCapabilities">setCapabilities</a></li><li><a href="global.html#setCenter">setCenter</a></li><li><a href="global.html#setCurrentTime">setCurrentTime</a></li><li><a href="global.html#setDayStartOffset">setDayStartOffset</a></li><li><a href="global.html#setDefaultTime">setDefaultTime</a></li><li><a href="global.html#setDragging">setDragging</a></li><li><a href="global.html#setEndTime">setEndTime</a></li><li><a href="global.html#setFirstDataPointTime">setFirstDataPointTime</a></li><li><a href="global.html#setFrameRate">setFrameRate</a></li><li><a href="global.html#setGridTime">setGridTime</a></li><li><a href="global.html#setInteractions">setInteractions</a></li><li><a href="global.html#setLastDataPointTime">setLastDataPointTime</a></li><li><a href="global.html#setLayers">setLayers</a></li><li><a href="global.html#setLayerVisible">setLayerVisible</a></li><li><a href="global.html#setMarkerVisible">setMarkerVisible</a></li><li><a href="global.html#setResolutionTime">setResolutionTime</a></li><li><a href="global.html#setRotation">setRotation</a></li><li><a href="global.html#setStaticControls">setStaticControls</a></li><li><a href="global.html#setTimeLimitsForced">setTimeLimitsForced</a></li><li><a href="global.html#setTimeStep">setTimeStep</a></li><li><a href="global.html#setTimeZone">setTimeZone</a></li><li><a href="global.html#setTimeZoneLabel">setTimeZoneLabel</a></li><li><a href="global.html#setZoom">setZoom</a></li><li><a href="global.html#showPopup">showPopup</a></li><li><a href="global.html#showTicks">showTicks</a></li><li><a href="global.html#sourceFactory">sourceFactory</a></li><li><a href="global.html#step">step</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#styleFactory">styleFactory</a></li><li><a href="global.html#supportOldBrowsers">supportOldBrowsers</a></li><li><a href="global.html#transformCoordinates">transformCoordinates</a></li><li><a href="global.html#updateAnimationBackupTime">updateAnimationBackupTime</a></li><li><a href="global.html#updateLayers">updateLayers</a></li><li><a href="global.html#updatePointer">updatePointer</a></li><li><a href="global.html#updateTimeLoaderVis">updateTimeLoaderVis</a></li><li><a href="global.html#updateTimeLoaderVisualizations">updateTimeLoaderVisualizations</a></li><li><a href="global.html#updateTimeSlider">updateTimeSlider</a></li><li><a href="global.html#updateTimeSteps">updateTimeSteps</a></li><li><a href="global.html#urlToDataUrl">urlToDataUrl</a></li><li><a href="global.html#ZINDEX">ZINDEX</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Sat Jul 27 2019 13:10:22 GMT+0300 (Eastern European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
