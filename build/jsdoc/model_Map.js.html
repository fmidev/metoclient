<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: model/Map.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: model/Map.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Map model for animator.
 * @author Finnish Meteorological Institute
 * @license MIT
 */

import 'core-js/fn/promise'

export default class Map {
  /**
   * Constructs a new map model.
   * @param {Object} config User configuration.
   * @param {number} referenceTime World creation time.
   * @constructor
   */
  constructor (config, referenceTime) {
    let numLayers = 0
    let featureId = 0
    let i
    this.config_ = config
    this.referenceTime_ = referenceTime
    this.capabilities_ = {}
    this.setLayers(config['layers'])
    if (this.layers_ != null) {
      numLayers = this.layers_.length
    }
    for (i = 0; i &lt; numLayers; i++) {
      if (this.layers_[i]['animation'] != null) {
        this.layers_[i]['animation']['referenceTime'] = this.referenceTime_
        if (this.layers_[i]['animation']['beginTime'] != null) {
          this.layers_[i]['animation']['originalBeginTime'] = this.layers_[i]['animation']['beginTime']
        }
        if (this.layers_[i]['animation']['endTime'] != null) {
          this.layers_[i]['animation']['originalEndTime'] = this.layers_[i]['animation']['endTime']
        }
      }
      if ((this.layers_[i]['className'].toLowerCase() === 'vector') &amp;&amp; (this.layers_[i]['type'] == null)) {
        this.layers_[i]['type'] = 'features'
      }
      if ((this.layers_[i]['type'] === 'features') &amp;&amp; (Array.isArray(this.layers_[i]['source']['features']))) {
        this.layers_[i]['source']['features'].forEach(feature => {
          if (feature['id'] == null) {
            featureId++
            feature['id'] = Date.now().toString() + featureId.toString()
          }
        })
      }
    }
  }

  /**
   * Gets map layers.
   * @returns {Array} Map layers.
   */
  getLayers () {
    return this.layers_
  }

  /**
   * Produces a full layer configuration for internal use.
   * @param layer Layer configuration supplied by the user.
   * @returns {Object} Full layer configuration.
   */
  static produceFullLayerConfig (layer) {
    if (((layer['type'] === 'obs') || (layer['type'] === 'for')) &amp;&amp; (layer['animation'] == null)) {
      layer['animation'] = {}
    } else if ((layer['className'].toLowerCase() === 'vector') &amp;&amp; (layer['type'] == null)) {
      layer['type'] = 'features'
    }
    return layer
  }

  /**
   * Sets map layers.
   * @param layers Map layers.
   */
  setLayers (layers) {
    this.layers_ = []
    let layerKeys = Object.keys(layers)
    layerKeys.forEach(layerKey => {
      this.layers_.push(Map.produceFullLayerConfig(layers[layerKey]))
    })
  }

  /**
   * Updates map layers.
   * @param layers Map layers.
   */
  updateLayers (layers) {
    let layerKeys = Object.keys(layers)
    layerKeys.forEach(layerKey => {
      this.layers_ = this.layers_.filter(layer => layer.title !== layerKey)
    })
    layerKeys.forEach(layerKey => {
      this.layers_.push(Map.produceFullLayerConfig(layers[layerKey]))
    })
  }

  /**
   * Refreshes layer models.
   * @param {number} currentTime Current real-world time.
   * @param {number} animationResolutionTime Animation resolution time.
   */
  refreshLayers (currentTime, animationResolutionTime) {
    let numLayers,
      timeDiff,
      layerTimeDiff,
      i
    if (this.layers_ != null) {
      if (animationResolutionTime != null) {
        timeDiff = Math.floor(currentTime / animationResolutionTime) * animationResolutionTime - Math.floor(this.referenceTime_ / animationResolutionTime) * animationResolutionTime
      } else {
        timeDiff = currentTime - this.referenceTime_
      }
      numLayers = this.layers_.length
      for (i = 0; i &lt; numLayers; i++) {
        if (this.layers_[i]['animation'] != null) {
          if (this.layers_[i]['animation']['resolutionTime'] != null) {
            layerTimeDiff = Math.floor(currentTime / this.layers_[i]['animation']['resolutionTime']) * this.layers_[i]['animation']['resolutionTime'] - Math.floor(this.referenceTime_ / this.layers_[i]['animation']['resolutionTime']) * this.layers_[i]['animation']['resolutionTime']
          } else {
            layerTimeDiff = timeDiff
          }
          this.layers_[i]['animation']['beginTime'] = (this.layers_[i]['animation']['originalBeginTime'] == null) ? undefined : this.layers_[i]['animation']['originalBeginTime'] + layerTimeDiff
          this.layers_[i]['animation']['endTime'] = (this.layers_[i]['animation']['originalEndTime'] == null) ? undefined : this.layers_[i]['animation']['originalEndTime'] + layerTimeDiff
        }
      }
    }
  }

  /**
   * Loads capability data from given urls.
   * @param {Object} capabilities Loaded capability data.
   * @returns {Array} Loader promises.
   */
  loadCapabilities (capabilities) {
    let numLayers
    const promises = []
    let i
    let j
    const urls = []
    let numUrls
    let layer
    const self = this
    if (this.layers_ == null) {
      return promises
    }
    numLayers = this.layers_.length
    // Collect urls
    for (i = 0; i &lt; numLayers; i++) {
      layer = this.layers_[i]
      if ((layer['timeCapabilitiesInit'] == null) &amp;&amp; (layer['timeCapabilities'] !== undefined) &amp;&amp; (!urls.includes(layer['timeCapabilities']))) {
        urls.push(layer['timeCapabilities'])
      }
      if ((layer['tileCapabilities'] !== undefined) &amp;&amp; (!urls.includes(layer['tileCapabilities']))) {
        urls.push(layer['tileCapabilities'])
      }
    }
    numUrls = urls.length
    // Load capabilities
    for (j = 0; j &lt; numUrls; j++) {
      ((url => {
        if (self.capabilities_[url] != null) {
          capabilities[url] = self.capabilities_[url]
          self.capabilities_[url] = null
        } else {
          promises.push(new Promise(function (resolve, reject) {
            let req = new XMLHttpRequest()
            req.open('GET', url)
            req.timeout = 20000
            req.onload = function () {
              if (req.status === 200) {
                capabilities[url] = req.response
                resolve(req.response)
              } else {
                reject(new Error(req.statusText))
              }
            }
            req.onerror = function () {
              reject(new Error('Network error'))
            }
            req.send()
          }))
        }
      }))(urls[j])
    }
    return promises
  }

  /**
   * Sets the capabilities data.
   * @param {Object} capabilities Capabilities data.
   */
  setCapabilities (capabilities) {
    const self = this
    capabilities.forEach(capability => {
      if (capability['url'] != null) {
        if (Array.isArray(capability['url'])) {
          capability['url'].forEach(url => {
            // Todo: optimize memory use
            self.capabilities_[url] = capability['data']
          })
        }
      } else {
        self.capabilities_[capability['url']] = capabilities['data']
      }
    })
  }

  /**
   * Gets the capabilities data.
   * @returns {Object} Capabilities data.
   */
  getCapabilities () {
    return this.capabilities_
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Base.html">Base</a></li><li><a href="Html.html">Html</a></li><li><a href="Internal.html">Internal</a></li><li><a href="MetOClient_MetOClient.html">MetOClient</a></li><li><a href="module.exports.html">exports</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="TimeFrame.module.exports.html">module.exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addFeatures">addFeatures</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#clearFeatures">clearFeatures</a></li><li><a href="global.html#configureTicks">configureTicks</a></li><li><a href="global.html#createContainers">createContainers</a></li><li><a href="global.html#createFrame">createFrame</a></li><li><a href="global.html#createFrames">createFrames</a></li><li><a href="global.html#createIndicators">createIndicators</a></li><li><a href="global.html#createMap">createMap</a></li><li><a href="global.html#createMenu">createMenu</a></li><li><a href="global.html#createPointer">createPointer</a></li><li><a href="global.html#createPostTools">createPostTools</a></li><li><a href="global.html#createPreMargin">createPreMargin</a></li><li><a href="global.html#createPreTools">createPreTools</a></li><li><a href="global.html#createTicks">createTicks</a></li><li><a href="global.html#createTime">createTime</a></li><li><a href="global.html#createTimeMenu">createTimeMenu</a></li><li><a href="global.html#createTimer">createTimer</a></li><li><a href="global.html#createTimeSlider">createTimeSlider</a></li><li><a href="global.html#createTimeZoneLabel">createTimeZoneLabel</a></li><li><a href="global.html#destroyAnimation">destroyAnimation</a></li><li><a href="global.html#destroyTime">destroyTime</a></li><li><a href="global.html#destroyTimer">destroyTimer</a></li><li><a href="global.html#destroyTimeSlider">destroyTimeSlider</a></li><li><a href="global.html#featureFactory">featureFactory</a></li><li><a href="global.html#filters">filters</a></li><li><a href="global.html#floorTime">floorTime</a></li><li><a href="global.html#getAnimationBackupTime">getAnimationBackupTime</a></li><li><a href="global.html#getAnimationBeginTime">getAnimationBeginTime</a></li><li><a href="global.html#getAnimationEndTime">getAnimationEndTime</a></li><li><a href="global.html#getAnimationNumIntervals">getAnimationNumIntervals</a></li><li><a href="global.html#getAnimationResolutionTime">getAnimationResolutionTime</a></li><li><a href="global.html#getAnimationTime">getAnimationTime</a></li><li><a href="global.html#getAnimationTimes">getAnimationTimes</a></li><li><a href="global.html#getCapabilities">getCapabilities</a></li><li><a href="global.html#getCreationTime">getCreationTime</a></li><li><a href="global.html#getCurrentTime">getCurrentTime</a></li><li><a href="global.html#getFeatures">getFeatures</a></li><li><a href="global.html#getFeaturesAt">getFeaturesAt</a></li><li><a href="global.html#getLayer">getLayer</a></li><li><a href="global.html#getLayerConfigs">getLayerConfigs</a></li><li><a href="global.html#getLayers">getLayers</a></li><li><a href="global.html#getMap">getMap</a></li><li><a href="global.html#getRefreshInterval">getRefreshInterval</a></li><li><a href="global.html#getStaticControls">getStaticControls</a></li><li><a href="global.html#getTickText">getTickText</a></li><li><a href="global.html#getTimeConfiguration">getTimeConfiguration</a></li><li><a href="global.html#getTimeLimitsForced">getTimeLimitsForced</a></li><li><a href="global.html#handleRefresh_">handleRefresh_</a></li><li><a href="global.html#handleTimer_">handleTimer_</a></li><li><a href="global.html#hidePopup">hidePopup</a></li><li><a href="global.html#isValidRefreshInterval">isValidRefreshInterval</a></li><li><a href="global.html#isWaitingAutoStart">isWaitingAutoStart</a></li><li><a href="global.html#layerFactory">layerFactory</a></li><li><a href="global.html#LEGEND_CONTAINER_CLASS">LEGEND_CONTAINER_CLASS</a></li><li><a href="global.html#LEGEND_FIGURE_CLASS_PREFIX">LEGEND_FIGURE_CLASS_PREFIX</a></li><li><a href="global.html#loadCapabilities">loadCapabilities</a></li><li><a href="global.html#loadFunction">loadFunction</a></li><li><a href="global.html#LOADING_STATUS">LOADING_STATUS</a></li><li><a href="global.html#MAX_TIMESTAMP">MAX_TIMESTAMP</a></li><li><a href="global.html#moveAnimationTimeFrame">moveAnimationTimeFrame</a></li><li><a href="global.html#next">next</a></li><li><a href="global.html#pause">pause</a></li><li><a href="global.html#play">play</a></li><li><a href="global.html#previous">previous</a></li><li><a href="global.html#produceFullLayerConfig">produceFullLayerConfig</a></li><li><a href="global.html#refreshLayers">refreshLayers</a></li><li><a href="global.html#refreshMap">refreshMap</a></li><li><a href="global.html#refreshTime">refreshTime</a></li><li><a href="global.html#requestViewUpdate">requestViewUpdate</a></li><li><a href="global.html#resetAnimationBackupTime">resetAnimationBackupTime</a></li><li><a href="global.html#selectFeature">selectFeature</a></li><li><a href="global.html#setAnimationLastRefreshed">setAnimationLastRefreshed</a></li><li><a href="global.html#setAnimationPlay">setAnimationPlay</a></li><li><a href="global.html#setAnimationTime">setAnimationTime</a></li><li><a href="global.html#setAnimationTimes">setAnimationTimes</a></li><li><a href="global.html#setBeginTime">setBeginTime</a></li><li><a href="global.html#setCallbacks">setCallbacks</a></li><li><a href="global.html#setCapabilities">setCapabilities</a></li><li><a href="global.html#setCenter">setCenter</a></li><li><a href="global.html#setCurrentTime">setCurrentTime</a></li><li><a href="global.html#setDayStartOffset">setDayStartOffset</a></li><li><a href="global.html#setDefaultTime">setDefaultTime</a></li><li><a href="global.html#setDragging">setDragging</a></li><li><a href="global.html#setEndTime">setEndTime</a></li><li><a href="global.html#setFirstDataPointTime">setFirstDataPointTime</a></li><li><a href="global.html#setFrameRate">setFrameRate</a></li><li><a href="global.html#setGridTime">setGridTime</a></li><li><a href="global.html#setInteractions">setInteractions</a></li><li><a href="global.html#setLastDataPointTime">setLastDataPointTime</a></li><li><a href="global.html#setLayers">setLayers</a></li><li><a href="global.html#setLayerVisible">setLayerVisible</a></li><li><a href="global.html#setMarkerVisible">setMarkerVisible</a></li><li><a href="global.html#setResolutionTime">setResolutionTime</a></li><li><a href="global.html#setRotation">setRotation</a></li><li><a href="global.html#setStaticControls">setStaticControls</a></li><li><a href="global.html#setTimeLimitsForced">setTimeLimitsForced</a></li><li><a href="global.html#setTimeStep">setTimeStep</a></li><li><a href="global.html#setTimeZone">setTimeZone</a></li><li><a href="global.html#setTimeZoneLabel">setTimeZoneLabel</a></li><li><a href="global.html#setZoom">setZoom</a></li><li><a href="global.html#showPopup">showPopup</a></li><li><a href="global.html#showTicks">showTicks</a></li><li><a href="global.html#sourceFactory">sourceFactory</a></li><li><a href="global.html#step">step</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#styleFactory">styleFactory</a></li><li><a href="global.html#supportOldBrowsers">supportOldBrowsers</a></li><li><a href="global.html#transformCoordinates">transformCoordinates</a></li><li><a href="global.html#updateAnimationBackupTime">updateAnimationBackupTime</a></li><li><a href="global.html#updateLayers">updateLayers</a></li><li><a href="global.html#updatePointer">updatePointer</a></li><li><a href="global.html#updateTimeLoaderVis">updateTimeLoaderVis</a></li><li><a href="global.html#updateTimeLoaderVisualizations">updateTimeLoaderVisualizations</a></li><li><a href="global.html#updateTimeSlider">updateTimeSlider</a></li><li><a href="global.html#updateTimeSteps">updateTimeSteps</a></li><li><a href="global.html#urlToDataUrl">urlToDataUrl</a></li><li><a href="global.html#ZINDEX">ZINDEX</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Sat Jul 27 2019 13:10:22 GMT+0300 (Eastern European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
